
BEGIN;
SELECT _v.register_patch('00142-osd-2014-bioarchive-codes-add',
                          array['00141-tara-satge-table-and-data-import'] );

-- section of creation best as user role megdb_admin
SET ROLE megdb_admin;



CREATE SCHEMA osdregistry_stage
  AUTHORIZATION megdb_admin;

GRANT USAGE ON SCHEMA osdregistry_stage TO megxuser;
GRANT ALL ON SCHEMA osdregistry_stage TO megx_team;
GRANT USAGE ON SCHEMA osdregistry_stage TO students;
COMMENT ON SCHEMA osdregistry_stage
  IS 'Staged Data for OSD Registry';

ALTER DEFAULT PRIVILEGES IN SCHEMA osdregistry_stage
    GRANT SELECT ON TABLES
    TO megx_team;



set search_path to osdregistry_stage, osdregistry, public;

-- for some test queries as user megxuser
-- SET ROLE megxuser;

create table osdregistry_stage.osd2014_bioarchive_codes (
  submission_id integer PRIMARY KEY,
  osd_id integer NOT NULL check (osd_id between  0 and 200),
  ena_acc text NOT NULL DEFAULT '' check (ena_acc ~ '^ERS|'), --regex means starts with ERS or is empty
  bioarchive_code text NOT NULL DEFAULT ''
);


COPY osdregistry_stage.osd2014_bioarchive_codes
FROM STDIN
WITH (FORMAT csv, HEADER, DELIMITER E'\t', NULL  '', FORCE_NOT_NULL(ena_acc,bioarchive_code) );
submission_id	osd_id	ena_acc	bioarchive_code
13	1	ERS667668	ABOKM42
36	2	ERS667667	ABOKL97
199	3	ERS667665	ABOKL44
200	3	ERS667666	ABOKM96
169	4	ERS667663	
168	4	ERS667664	ABOKM15
114	5	ERS667661	ABOKM52
120	5	ERS667662	ABOKL71
42	6	ERS667660	ABOKM05
142	7	ERS667659	ABOKL89
8	9	ERS667658	ABOKL81
45	10	ERS667657	ABOKM00
180	11	ERS667656	
31	13	ERS667655	ABOKM46
154	14	ERS667654	ABOKN03
33	15	ERS667652	ABOKM50
32	15	ERS667653	ABOKM93
12	17	ERS667651	ABOKL99
148	18	ERS667650	
240	19	ERS667649	
227	20	ERS667648	ABOKN09
226	20	ERS667647	ABOKM41
216	21	ERS667646	ABOKL42
11	22	ERS667645	ABOKL65
46	24	ERS667644	ABOKM32
48	25	ERS667643	ABOKM23
47	26	ERS667642	ABOKM48
181	28	ERS667641	ABOKM37
182	29	ERS667640	ABOKM97
103	30	ERS667639	ABOKM77
101	30	ERS667638	ABOKL95
247	31	ERS667637	
249	32	ERS667636	
245	33	ERS667635	
94	34	ERS667634	ABOKM65
15	35	ERS667633	ABOKM98
16	36	ERS667632	ABOKL75
173	37	ERS667630	ABOKL77
176	37	ERS667631	ABOKM83
174	38	ERS667629	ABOKL79
40	39	ERS667628	ABOKM95
93	41	ERS667627	ABOKM12
43	42	ERS667626	
109	43	ERS667624	ABOKM78
92	43	ERS667625	ABOKM27
175	45	ERS667623	ABOKL68
190	46	ERS667622	ABOKL78
149	47	ERS667621	ABOKM66
150	48	ERS667620	ABOKM21
126	49	ERS667619	ABOKL74
29	50	ERS667618	ABOKM69
122	51	ERS667616	ABOKL93
59	52	ERS667609	ABOKN00
81	53	ERS667608	ABOKM53
260	54	ERS667606	ABOKL91
139	54	ERS667607	ABOKM79
137	55	ERS667604	ABOKM64
140	55	ERS667605	ABOKM80
54	56	ERS667603	ABOKL67
55	57	ERS667602	ABOKL64
39	58	ERS667601	ABOKM28
44	60	ERS667600	ABOKM20
91	61	ERS667599	ABOKL94
188	62	ERS667598	ABOKL62
160	63	ERS667597	ABOKM34
89	64	ERS667596	ABOKL73
223	65	ERS667595	ABOKL56
151	69	ERS667594	ABOKM43
152	70	ERS667593	ABOKM59
96	71	ERS667592	ABOKM01
28	72	ERS667590	
27	72	ERS667591	ABOKL70
172	73	ERS667589	ABOKL69
115	74	ERS667588	ABOKL86
144	76	ERS667586	ABOKN01
141	76	ERS667587	ABOKM84
145	77	ERS667584	ABOKM87
147	77	ERS667585	ABOKL98
17	78	ERS667583	ABOKM68
170	80	ERS667580	ABOKL63
177	80	ERS667581	
178	80	ERS667582	ABOKM07
135	81	ERS667579	ABOKL82
14	87	ERS667578	
71	90	ERS667577	ABOKM74
52	91	ERS667576	ABOKM18
50	92	ERS667575	ABOKM67
51	93	ERS667574	ABOKM61
49	94	ERS667573	ABOKM24
108	95	ERS667572	ABOKM49
87	96	ERS667571	ABOKM10
37	97	ERS667570	ABOKM14
79	98	ERS667569	ABOKM60
143	99	ERS667567	ABOKM35
146	99	ERS667568	
117	100	ERS667565	ABOKM19
116	100	ERS667566	ABOKL72
229	101	ERS667564	ABOKL61
230	102	ERS667563	ABOKL45
231	103	ERS667562	ABOKN06
179	105	ERS667561	ABOKM11
225	106	ERS667559	ABOKM36
224	106	ERS667560	ABOKN07
233	107	ERS667558	ABOKL57
234	108	ERS667557	ABOKM08
235	109	ERS667556	ABOKL46
236	110	ERS667555	ABOKL58
237	111	ERS667554	ABOKL54
222	113	ERS667553	ABOKL76
241	114	ERS667552	ABOKL85
238	115	ERS667551	ABOKL47
239	116	ERS667550	ABOKL59
215	117	ERS667549	ABOKL92
9	118	ERS667548	ABOKM55
164	119	ERS667547	
165	120	ERS667546	
166	121	ERS667545	
196	122	ERS667544	ABOKM54
189	123	ERS667543	ABOKL83
184	124	ERS667541	ABOKM72
183	124	ERS667542	ABOKM91
251	125	ERS667540	ABOKM38
254	126	ERS667539	ABOKM13
255	127	ERS667538	ABOKM16
256	128	ERS667537	ABOKM57
257	129	ERS667536	ABOKM22
258	130	ERS667535	ABOKM26
66	131	ERS667534	ABOKM40
198	132	ERS667533	ABOKL90
97	133	ERS667532	ABOKM17
136	135	ERS667530	
34	135	ERS667531	
35	136	ERS667529	
107	141	ERS667527	ABOKM89
106	141	ERS667528	ABOKL43
105	142	ERS667525	ABOKM88
104	142	ERS667526	ABOKM39
77	143	ERS667523	ABOKN04
78	143	ERS667524	ABOKM86
53	144	ERS667522	ABOKM03
221	145	ERS667521	ABOKM62
56	146	ERS667520	ABOKL87
10	147	ERS667519	ABOKM58
18	148	ERS667518	ABOKM51
82	149	ERS667516	ABOKM92
80	149	ERS667517	ABOKN08
83	150	ERS667515	ABOKN05
84	151	ERS667514	ABOKM33
85	151	ERS667513	ABOKM75
21	152	ERS667509	ABOKM06
22	152	ERS667510	ABOKM82
24	152	ERS667511	ABOKL96
26	152	ERS667512	ABOKM09
134	153	ERS667508	ABOKL66
186	154	ERS667507	ABOKL80
204	155	ERS667505	ABOKL53
201	155	ERS667506	ABOKL52
208	156	ERS667503	ABOKL51
209	156	ERS667504	ABOKL50
211	157	ERS667501	ABOKL48
210	157	ERS667502	ABOKL49
88	158	ERS667500	ABOKM56
90	159	ERS667499	ABOKM25
153	162	ERS667498	ABOKM70
155	163	ERS667497	ABOKN02
269	164		ABOKM47
157	165	ERS667496	ABOKM31
156	166	ERS667495	ABOKL84
259	167	ERS667494	ABOKM29
158	168	ERS667493	ABOKL88
250	169	ERS667492	ABOKM30
191	170	ERS667491	
192	171	ERS667490	
193	172	ERS667489	
195	173	ERS667488	
194	174	ERS667487	
197	175	ERS667486	
205	176	ERS667485	
206	177	ERS667484	
207	178	ERS667483	
228	182	ERS667482	
212	183	ERS667481	
213	184	ERS667480	
214	185	ERS667479	
30	186	ERS667478	ABOKL60
246	188	ERS667477	
248	189	ERS667476	
244	190	ERS667475	
243	191	ERS667474	
\.


--select * from osdregistry_stage.osd2014_bioarchive_codes;

UPDATE osdregistry.samples as sam
   SET bioarchive_code = b.bioarchive_code
  FROM osdregistry_stage.osd2014_bioarchive_codes as b
 WHERE sam.submission_id = b.submission_id
 returning sam.osd_id, sam.bioarchive_code,b.osd_id, sam.ena_acc, b.ena_acc
;

commit;


